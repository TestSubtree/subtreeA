

name: 테스트용


on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  check_conflict_only:
    if: github.event_name == 'pull_request' && github.event.pull_request.head.ref != 'main' && github.event.pull_request.draft == false
    runs-on: ubuntu-slim

    steps:
      - name: checkout subtreeC
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: remove github actions extraheader
        run: git config --unset-all http.https://github.com/.extraheader
        shell: bash

      - name: clone subtreeC
        run: |
          git clone --branch main --depth 1 https://x-access-token:${{ secrets.TT }}@github.com/TestSubtree/subtreeC.git repository_database || { echo "Error: Failed to clone repository B."; exit 1; }

      - name: remove .git folder from subtree
        run: |
          echo "Removing .git folder from repository B..."
          rm -rf repository_database/.git || { echo "Error: Failed to remove .git folder from repository B."; exit 1; }

      - name: Check subtree changes
        run: |
          set +e
          git --no-pager diff --exit-code --no-index C/ repository_database/ > diff_output.txt
          diff_exit_code=$?
          if [ $diff_exit_code -eq 0 ]; then
            echo "no_changes=true" >> $GITHUB_ENV
          elif [ $diff_exit_code -eq 1 ]; then
            echo "no_changes=false" >> $GITHUB_ENV
          else
            echo "❌ Error: git diff command failed with exit code $exit_code"
            exit 1
          fi

      - name: no changes message
        if: env.no_changes == 'true'
        run: echo "✅ success"

      - name: Subtree changes details
        if: env.no_changes == 'false'
        run: |
          echo "다음과 같은 상세한 수정사항이 있습니다:"
          git --no-pager diff --no-index C/ repository_database/ || echo "Error: Failed to display subtree changes."
        shell: bash

      - name: check for merge conflicts (no push)
        if: env.no_changes == 'false'
        run: |
          if ! git subtree split --prefix=C -b temp_subtree_branch; then
            echo "❌ err: C/ 부분만 subtree 브랜치로 분리에러 발생"
            exit 1
          fi

          if ! git fetch https://x-access-token:${{ secrets.TT }}@github.com/TestSubtree/subtreeC.git main:temp_subtreeC_main; then
            echo "❌ err: subtreeC의 main 브랜치를 가져옴 에러 발생"
            exit 1
          fi

          git checkout temp_subtree_branch

          SUBTREE_HEAD=$(git rev-parse HEAD)

          if ! git merge --no-commit --no-ff temp_subtreeC_main; then
            echo "❌ 충돌 발생"
            exit 1
          fi

          git reset --hard "$SUBTREE_HEAD"
          git checkout main
          git branch -D temp_subtree_branch temp_subtreeC_main
          echo "✅ 完了しました。"


  create_auto_pr_after_merge:
    if: github.event_name == 'push'
    runs-on: ubuntu-slim

    steps:
      - name: checkout Subtree
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: remove github actions extraheader
        run: git config --unset-all http.https://github.com/.extraheader

      - name: clone subtreeC
        run: |
          git clone --branch main --depth 1 https://x-access-token:${{ secrets.TT }}@github.com/TestSubtree/subtreeC.git repository_database || { echo "Error: Failed to clone repository B."; exit 1; }


      - name: remove .git folder
        run: rm -rf repository_database/.git

      - name: check subtree changes
        run: |
          set +e
          git --no-pager diff --exit-code --no-index C/ repository_database/ > diff_output.txt
          diff_exit_code=$?
          if [ $diff_exit_code -eq 0 ]; then
            echo "no_changes=true" >> $GITHUB_ENV
          elif [ $diff_exit_code -eq 1 ]; then
            echo "no_changes=false" >> $GITHUB_ENV
          else
            echo "❌ Error: git diff command failed with exit code $exit_code"
            exit 1
          fi

      - name: no changes message
        if: env.no_changes == 'true'
        run: echo "✅ 차분 없음"

      - name: check for merge conflicts (no push)
        if: env.no_changes == 'false'
        run: |
          run: |
          if ! git subtree split --prefix=C -b temp_subtree_branch; then
            echo "❌ err: C/ 부분만 subtree 브랜치로 분리에러 발생"
            exit 1
          fi

          if ! git fetch https://x-access-token:${{ secrets.TT }}@github.com/TestSubtree/subtreeC.git main:temp_subtreeC_main; then
            echo "❌ err: subtreeC의 main 브랜치를 가져옴 에러 발생"
            exit 1
          fi

          git checkout temp_subtree_branch

          SUBTREE_HEAD=$(git rev-parse HEAD)

          if ! git merge --no-commit --no-ff temp_subtreeC_main; then
            echo "❌ 충돌 발생"
            exit 1
          fi

          git reset --hard "$SUBTREE_HEAD"
          git checkout main
          git branch -D temp_subtree_branch temp_subtreeC_main

      - name: get origin PR info
        if: env.no_changes == 'false'
        run: |
          REPO="${{ github.repository }}"
          SHA="${{ github.sha }}"

          PRS_RESPONSE=$(mktemp)
          STATUS=$(curl -s -w "%{http_code}" -o "$PRS_RESPONSE" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.groot-preview+json" \
            "https://api.github.com/repos/${REPO}/commits/${SHA}/pulls")

          if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
            echo "❌ 에러: PR정보 습득 실패"
            cat "$PRS_RESPONSE"
            exit 1
          fi

          if ! jq empty "$PRS_RESPONSE" 2>/dev/null; then
            echo "❌ err: JSON형식이 아니야"
            cat "$PRS_RESPONSE"
            exit 1
          fi

          ORIGIN_PR_NUMBER=$(jq -r '[.[] | select(.merged_at != null and .base.ref == "develop")][0].number // empty' "$PRS_RESPONSE")
          ORIGIN_PR_URL=$(jq -r '[.[] | select(.merged_at != null and .base.ref == "develop")][0].html_url // empty' "$PRS_RESPONSE")
          ORIGIN_PR_BRANCH=$(jq -r '[.[] | select(.merged_at != null and .base.ref == "develop")][0].head.ref // empty' "$PRS_RESPONSE")

          echo "ORIGIN_PR_NUMBER=$ORIGIN_PR_NUMBER" >> $GITHUB_ENV
          echo "ORIGIN_PR_URL=$ORIGIN_PR_URL" >> $GITHUB_ENV
          echo "ORIGIN_PR_BRANCH=$ORIGIN_PR_BRANCH" >> $GITHUB_ENV

          rm -f "$PRS_RESPONSE"

      - name: push subtree 
        if: env.no_changes == 'false'
        run: |
          BR="auto/subtree-sync-${{ github.run_number }}"

          if [ -n "${{ env.ORIGIN_PR_BRANCH }}" ]; then
            BR="${{ env.ORIGIN_PR_BRANCH }}"
          elif [ -n "${{ env.ORIGIN_PR_NUMBER }}" ]; then
            BR="auto/subtree-from-pr-${{ env.ORIGIN_PR_NUMBER }}"
          fi


          git checkout -b "$BR"

          git remote add subtreeC https://x-access-token:${{ secrets.TT }}@github.com/TestSubtree/subtreeC.git
          git subtree push --prefix=C subtreeC "$BRANCH_NAME" || { echo "Error: Failed to push changes to subtreeC."; exit 1; }
          if [ $? -ne 0 ]; then
            echo "❌ 푸쉬 실패"
            exit 1
          fi

      - name: create PR in subtree
        if: env.no_changes == 'false'
        run: |
          BR="auto/subtree-sync-${{ github.run_number }}"

          if [ -n "${{ env.ORIGIN_PR_BRANCH }}" ]; then
            BR="${{ env.ORIGIN_PR_BRANCH }}"
          elif [ -n "${{ env.ORIGIN_PR_NUMBER }}" ]; then
            BR="auto/subtree-from-pr-${{ env.ORIGIN_PR_NUMBER }}"
          fi

          BASE_BRANCH="main"

          PR_BRANCH="${{ env.ORIGIN_PR_BRANCH }}"
          if [ -z "$PR_BRANCH" ]; then
            PR_BRANCH="$BR"
          fi

          PR_URL="${{ env.ORIGIN_PR_URL }}"

          if [ -n "$PR_URL" ]; then
            PR_BODY="[피알[こちら]($PR_URL)]"
          else
            PR_BODY="[피알 주소 못 찾음]"
          fi

          PR_PAYLOAD=$(jq -nc \
            --arg title "SubtreeA로부터 만들어졌음: $PR_BRANCH" \
            --arg head  "$BR" \
            --arg base  "$BASE_BRANCH" \
            --arg body  "$PR_BODY" \
            '{title: $title, head: $head, base: $base, body: $body}')

          echo "PR_PAYLOAD=$PR_PAYLOAD"

          PR_RESPONSE=$(mktemp)
          PR_STATUS=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.TT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/TestSubtree/subtreeC/pulls \
            -d "$PR_PAYLOAD" \
            -o "$PR_RESPONSE" -w "%{http_code}")

          PR_BODY=$(cat "$PR_RESPONSE")
          rm -f "$PR_RESPONSE"

          if [ "$PR_STATUS" -lt 200 ] || [ "$PR_STATUS" -ge 300 ]; then
            echo "❌ PR작성에 실패"
            echo "❌ 레스폰스: $PR_BODY"
            exit 1
          fi

          DB_PR_URL=$(echo "$PR_BODY" | jq -r '.html_url // empty')

          if [ -z "$DB_PR_URL" ] || [ "$DB_PR_URL" = "null" ]; then
            echo "❌ PR작성은 성공, 다만 그 후에 pr url을 습득에 실패"
            echo "❌ 레스폰스: $PR_BODY"
            exit 1
          fi

          echo "DB_PR_URL=$DB_PR_URL" >> $GITHUB_ENV
          echo "➡️ 자동 PR생성 성공: $DB_PR_URL"

      - name: update original PR body (append subtreer PR URL)
        if: env.no_changes == 'false' && env.ORIGIN_PR_NUMBER != '' && env.DB_PR_URL != ''
        run: |
          REPO="${{ github.repository }}"
          NUM="${{ env.ORIGIN_PR_NUMBER }}"
          URL="${{ env.DB_PR_URL }}"

          ORIGINAL=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${REPO}/pulls/${NUM}")

          ORIGINAL_BODY_FILE=$(mktemp)
          echo "$ORIGINAL" | jq -r '.body // ""' > "$ORIGINAL_BODY_FILE"
          ORIGINAL_BODY=$(cat "$ORIGINAL_BODY_FILE")
          rm -f "$ORIGINAL_BODY_FILE"

          NEW_BODY=$(jq -n --arg body "$ORIGINAL_BODY" --arg url "$URL" \
            '$body + "\n\n### Tempura-db-manager\n- " + $url')

          PATCH_RESPONSE=$(mktemp)
          PATCH_STATUS=$(curl -s -X PATCH \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${REPO}/pulls/${NUM}" \
            -d "$(jq -c --arg body "$NEW_BODY" '{body: $body}')" \
            -o "$PATCH_RESPONSE" -w "%{http_code}")

          PATCH_BODY=$(cat "$PATCH_RESPONSE")
          rm -f "$PATCH_RESPONSE"

          if [ "$PATCH_STATUS" -lt 200 ] || [ "$PATCH_STATUS" -ge 300 ]; then
            echo "❌ PR본문 수정 불가: $PATCH_STATUS"
            echo "❌ 레스폰스: $PATCH_BODY"
            exit 1
          fi
          echo "✅ 성공"
